"""Llama Dataset Class."""

from dataclasses import dataclass
from typing import List

from pandas import DataFrame as PandasDataFrame

from llama_index.core import BaseQueryEngine
from llama_index.llama_dataset.base import (
    BaseLlamaDataExample,
    BaseLlamaDataset,
    BaseLlamaPrediction,
    CreatedByType,
)


@dataclass(repr=True)
class RagExamplePrediction(BaseLlamaPrediction):
    """RAG example prediction class.

    Args:
        response: str
        contexts: List[str]
    """

    response: str
    contexts: List[str]

    @property
    def class_name(self) -> str:
        """Data example class name."""
        return "LlamaRagDataExample"


@dataclass(repr=True)
class LabelledRagDataExample(BaseLlamaDataExample):
    """RAG example class. Analogous to traditional ML datasets, this dataset contains
    the "features" (i.e., query + context) to make a prediction and the "label" (i.e., response)
    to evaluate the prediction.

    Args:
        query (str): The user query
        kind (LlamaRagDataExampleKind): The example is generated by human or ai
        reference_contexts (List[str] or List[TextNode]): The contexts used for response
        reference_answer ([str]): Reference answer to the query. An answer
                                    that would receive full marks upon evaluation.
    """

    query: str
    query_by: CreatedByType
    reference_contexts: List[str]
    reference_answer: str
    reference_answer_by: CreatedByType

    @property
    def class_name(self) -> str:
        """Data example class name."""
        return "LlamaRagDataExample"


class LabelledRagDataset(BaseLlamaDataset):
    """RagDataset class."""

    _examples_type = LabelledRagDataExample
    _predictions_type = RagExamplePrediction

    def to_pandas(self) -> PandasDataFrame:
        """Create pandas dataframe."""
        data = {
            "query": [t.query for t in self.train_examples]
            + [t.query for t in self.test_examples],
            "reference_contexts": [t.reference_contexts for t in self.train_examples]
            + [t.reference_contexts for t in self.test_examples],
            "reference_answer": [t.reference_answer for t in self.train_examples]
            + [t.reference_answer for t in self.test_examples],
            "reference_answer_by": [
                str(t.reference_answer_by) for t in self.train_examples
            ]
            + [str(t.reference_answer_by) for t in self.test_examples],
            "query_by": [str(t.query_by) for t in self.train_examples]
            + [str(t.query_by) for t in self.test_examples],
            "split": ["train"] * len(self.train_examples)
            + ["test"] * len(self.test_examples),
        }

        # add predictions if they exist
        predictions = []
        if self.train_predictions:
            predictions += self.train_predictions
        if self.test_predictions:
            predictions += self.test_predictions

        if predictions:
            data.update(
                {
                    "prediction": [p.response for p in predictions],
                    "prediction_contexts": [p.contexts for p in predictions],
                }
            )
        return PandasDataFrame(data)

    def _predict_example(
        self,
        query_engine: BaseQueryEngine,
        example: LabelledRagDataExample,
    ) -> RagExamplePrediction:
        """Predict RAG example with a query engine."""
        response = query_engine.query(example.query)
        return RagExamplePrediction(
            response=response.response, contexts=[s.text for s in response.source_nodes]
        )
